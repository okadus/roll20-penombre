<div class="penombre-sheet">



    <div class="columns">
        <!-- Colonne gauche -->
        <div class="col-left">

            <!-- ================= Identité ================== -->
            <section class="section-identite">
                <div class="identite-container">
                    <h3 class="titre-vertical identite-titre">
                        <span>Personnage</span>
                    </h3>

                    <div class="identite-champs">
                        <div class="identite-champ"><label>Nom</label><input type="text" name="attr_char_name"></div>
                        <div class="identite-champ"><label>Peuple</label><input type="text" name="attr_peuple"></div>
                        <!-- <div><label>Clé</label><input type="text" name="attr_cle"></div>
                        <div><label>Gamme</label><input type="text" name="attr_gamme"></div>
                        <div><label>Ton</label><input type="text" name="attr_ton"></div> -->
                    </div>
                </div>
            </section>


            <!-- ================= Harmoniques ================== -->
            <section class="section-harmoniques">
                <div class="harmoniques-container">
                    <h3 class="titre-vertical harmoniques-titre">
                        <span>Harmoniques</span>
                    </h3>

                    <div class="harmoniques-grid">
                        <div class="harmonique-wrap">
                            <div class="harmonique">
                                <select name="attr_nuit">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Nuit</button>
                            <span class="sub-label">Action scélérate</span>

                        </div>

                        <div class="harmonique-wrap">
                            <div class="harmonique">
                                <select name="attr_ame">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Âme</button>
                            <span class="sub-label">Action sociale</span>

                        </div>

                        <div class="harmonique-wrap nature-wrap">
                            <div class="harmonique">
                                <select name="attr_nature">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Nature</button>
                            <span class="sub-label">Action physique</span>

                        </div>

                        <div class="harmonique-wrap esprit-wrap">
                            <div class="harmonique">
                                <select name="attr_esprit">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Esprit</button>
                            <span class="sub-label">Action mentale</span>
                        </div>

                        <div class="harmonique-wrap etincelle-wrap">
                            <div class="harmonique">
                                <select name="attr_etincelle">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Étincelle</button>
                            <span class="sub-label">Action perceptive</span>
                        </div>
                    </div>
                </div>
            </section>
            <!-- ================= Conscience ================= -->
            <section class="section-conscience">
                <div class="conscience-container">
                    <h3 class="titre-vertical conscience-titre">
                        <span>Conscience</span>
                    </h3>
                    <div class="conscience-wrapper">
                        <div class="conscience-header">
                            <h4>Max</h4>
                            <input type="number" name="attr_conscience_max" value="7" min="0" max="15">
                        </div>

                        <!-- input caché contrôlé automatiquement par le sheet-worker -->
                        <input type="hidden" name="attr_cmax" value="0">


                        <!-- Radios cachés : 1 seul attribut attr_cmax (1..10) -->
                        <div class="cmax-radios">
                            <input type="hidden" name="attr_show_token1" value="on">
                            <input type="hidden" name="attr_show_token2" value="on">
                            <input type="hidden" name="attr_show_token3" value="on">
                            <input type="hidden" name="attr_show_token4" value="on">
                            <input type="hidden" name="attr_show_token5" value="on">
                            <input type="hidden" name="attr_show_token6" value="on">
                            <input type="hidden" name="attr_show_token7" value="on">
                            <input type="hidden" name="attr_show_token8" value="0">
                            <input type="hidden" name="attr_show_token9" value="0">
                            <input type="hidden" name="attr_show_token10" value="0">
                        </div>

                        <!-- 15 jetons -->
                        <div class="tokens">
                            <div class="token"><input type="hidden" name="attr_token1" value="0"><button type="action"
                                    name="act_token1" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token2" value="0"><button type="action"
                                    name="act_token2" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token3" value="0"><button type="action"
                                    name="act_token3" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token4" value="0"><button type="action"
                                    name="act_token4" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token5" value="0"><button type="action"
                                    name="act_token5" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token6" value="0"><button type="action"
                                    name="act_token6" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token7" value="0"><button type="action"
                                    name="act_token7" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token8" value="0"><button type="action"
                                    name="act_token8" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token9" value="0"><button type="action"
                                    name="act_token9" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token10" value="0"><button type="action"
                                    name="act_token10" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token11" value="0"><button type="action"
                                    name="act_token11" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token12" value="0"><button type="action"
                                    name="act_token12" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token13" value="0"><button type="action"
                                    name="act_token13" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token14" value="0"><button type="action"
                                    name="act_token14" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token15" value="0"><button type="action"
                                    name="act_token15" class="token-btn"></button></div>
                        </div>

                        <!-- Complications -->
                        <div class="complications">
                            <h4>Complications</h4>
                            <div class="comp-row">
                                <input type="text" name="attr_complication1">
                                <input type="checkbox" name="attr_comp1a"><input type="checkbox"
                                    name="attr_comp1b"><input type="checkbox" name="attr_comp1c">
                            </div>
                            <div class="comp-row">
                                <input type="text" name="attr_complication2">
                                <input type="checkbox" name="attr_comp2a"><input type="checkbox"
                                    name="attr_comp2b"><input type="checkbox" name="attr_comp2c">
                            </div>
                            <div class="comp-row">
                                <input type="text" name="attr_complication3">
                                <input type="checkbox" name="attr_comp3a"><input type="checkbox"
                                    name="attr_comp3b"><input type="checkbox" name="attr_comp3c">
                            </div>
                            <div class="comp-row">
                                <input type="text" name="attr_complication4">
                                <input type="checkbox" name="attr_comp4a"><input type="checkbox"
                                    name="attr_comp4b"><input type="checkbox" name="attr_comp4c">
                            </div>
                            <p class="comp-help">(pensez à en créer pour préserver vos jetons)</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Colonne droite -->
        <div class="col-right">

            <!-- Bandeau supérieur -->
            <header class="header">
                <img src="https://i.imgur.com/RqiNP2C.png" class="logo" alt="Logo Pénombre">
            </header>

            <!-- ================= Pouvoirs ================== -->
            <section class="pouvoirs">
                <h2>Pouvoirs</h2>

                <div class="capacites-flex">
                    <!-- Colonne gauche : Potentiel -->
                    <div class="col-potentiel">
                        <div class="potentiel-wrap">
                            <div class="potentiel-img" aria-hidden="true"></div>
                            <input type="number" name="attr_pouvoir_potentiel" class="potentiel-input" value="0"
                                min="0">
                            <div class="potentiel-caption">Potentiel</div>
                        </div>
                    </div>

                    <!-- Colonne droite : pouvoirs -->
                    <div class="col-pouvoirs">

                        <fieldset class="repeating_pouvoirs">
                            <div class="pouvoir-row">
                                <input type="checkbox" name="attr_pouvoir_used">
                                <input type="text" name="attr_nom_pouvoir" placeholder="Nom du pouvoir">
                                <textarea name="attr_pouvoir" placeholder="Pouvoir"></textarea>
                                <select name="attr_pouvoir_type">
                                    <option value="naissance">Naissance</option>
                                    <option value="peuple">Peuple</option>
                                    <option value="cle">Clé</option>
                                    <option value="gamme">Gamme</option>
                                    <option value="ton">Ton</option>
                                </select>
                                <button type="roll" name="roll_pouvoir" class="btn-roll" value="">
                                </button>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </section>

            <!-- ================= Atouts ================== -->
            <section class="atouts">
                <h2>Atouts</h2>

                <div class="capacites-flex">
                    <!-- Colonne gauche : Potentiel -->
                    <div class="col-potentiel">
                        <div class="potentiel-wrap">
                            <div class="potentiel-img" aria-hidden="true"></div>
                            <input type="number" name="attr_atout_potentiel" class="potentiel-input" value="0" min="0">
                            <div class="potentiel-caption">Potentiel</div>
                        </div>
                    </div>

                    <!-- Colonne droite : atouts -->
                    <div class="col-atouts">

                        <fieldset class="repeating_atouts">
                            <div class="atout-row">
                                <input type="text" name="attr_nom_atout" placeholder="Nom de l'atout">
                                <div class="atout-level-row">
                                    <input type="checkbox" class="case" name="attr_lvl1">
                                    <input type="checkbox" class="case" name="attr_lvl2">
                                    <input type="checkbox" class="case" name="attr_lvl3">

                                    <input type="hidden" name="attr_atout_nd6" value="0">
                                </div>

                                <button type="roll" name="roll_atout" class="btn-roll" value="/r @{atout_nd6}d6">
                                </button>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </section>

            <!-- ================= Maîtrises magiques ================== -->

            <section class="maitrise-magie">
                <h2>Pouvoirs</h2>

                <div class="capacites-flex">
                    <!-- Colonne gauche : Potentiel -->
                    <div class="col-potentiel">
                        <div class="potentiel-wrap">
                            <div class="potentiel-img" aria-hidden="true"></div>
                            <input type="number" name="attr_magie_potentiel" class="potentiel-input" value="0" min="0">
                            <div class="potentiel-caption">Potentiel</div>
                        </div>
                    </div>

                    <!-- Colonne droite : maitrises magiques -->
                    <div class="col-magies">

                        <fieldset class="repeating_magies">
                            <div class="magie-row">
                                <!-- <input type="text" name="attr_nom_magie" placeholder="Nom de la magie"> -->
                                <input type="text" name="attr_magie" placeholder="Magie">
                                <select name="attr_magie_harmonique">
                                    <option value="@{ame}">Âme</option>
                                    <option value="@{esprit}">Esprit</option>
                                    <option value="@{etincelle}">Étincelle</option>
                                    <option value="@{nature}">Nature</option>
                                    <option value="@{nuit}">Nuit</option>
                                </select>
                                <textarea name="attr_magie_prerequis" placeholder="prérequis &#x21B5;"></textarea>
                                <div class="magie-lvl-img" aria-hidden="true">
                                    <input type="number" name="attr_magie_niveau" class="magie-lvl-input" value="0"
                                        min="0" max="5">
                                </div>


                            </div>
                        </fieldset>
                    </div>
                </div>
            </section>

        </div>
    </div>
</div>
<script type="text/worker">
  /* Synchronise la valeur de Conscience Max -> cmax */
  on("change:conscience_max sheet:opened", function() {
    getAttrs(["conscience_max"], function(v) {
      let cmax = parseInt(v.conscience_max, 10) || 0;
      cmax = Math.max(0, Math.min(15, cmax));
      setAttrs({ cmax: String(cmax) }, { silent: true });
    });
  });

  /* Cycle des 15 jetons (0→1→2→0) */
  const ids = Array.from({ length: 15 }, (_, i) => String(i + 1));
  ids.forEach(i => {
    on(`clicked:token${i}`, function() {
      getAttrs([`token${i}`], function(v) {
        let cur = parseInt(v[`token${i}`], 10);
        if (isNaN(cur)) cur = 0;
        const next = (cur + 1) % 3;
        const upd = {};
        upd[`token${i}`] = String(next);
        setAttrs(upd);
      });
    });
  });

  on("change:repeating_atouts:lvl1 change:repeating_atouts:lvl2 change:repeating_atouts:lvl3", (e) => {
    const base = e.sourceAttribute.replace(/_(lvl1|lvl2|lvl3)$/, "");
    
    // Détermine quelle case a été modifiée
    const changedLevel = e.sourceAttribute.match(/lvl([123])$/)?.[1];
    
    const keys = [`${base}_lvl1`, `${base}_lvl2`, `${base}_lvl3`];
    
    getAttrs(keys, (v) => {
        let l1 = v[`${base}_lvl1`] === "on";
        let l2 = v[`${base}_lvl2`] === "on";
        let l3 = v[`${base}_lvl3`] === "on";
        
        // === Logique hiérarchique bidirectionnelle ===
        
        if (changedLevel === "3") {
            // On a cliqué sur niveau 3
            if (l3) {
                // Cocher 3 → coche aussi 1 et 2
                l1 = true;
                l2 = true;
            } else {
                // Décocher 3 → laisse 1 et 2 tels quels
                // (ne fait rien)
            }
        } else if (changedLevel === "2") {
            // On a cliqué sur niveau 2
            if (l2) {
                // Cocher 2 → coche aussi 1, décoche 3
                l1 = true;
                l2 = true;
                l3 = false;
            } else {
                // Décocher 2 → décoche aussi 3, laisse 1 tel quel
                l3 = false;
                l2 = false;
            }
        } else if (changedLevel === "1") {
            // On a cliqué sur niveau 1
            if (l1) {
                // Cocher 1 → décoche 2 et 3
                l2 = false;
                l3 = false;
                l1 = true;
            } else {
                // Décocher 1 → décoche tout
                l2 = false;
                l3 = false;
                
            }
        }
        
        // Calcule le nombre de dés (compte combien sont cochés)
        const nd6 = (l1 ? 1 : 0) + (l2 ? 1 : 0) + (l3 ? 1 : 0);
        
        const set = {};
        set[`${base}_lvl1`] = l1 ? "on" : "0";
        set[`${base}_lvl2`] = l2 ? "on" : "0";
        set[`${base}_lvl3`] = l3 ? "on" : "0";
        set[`${base}_atout_nd6`] = String(nd6);
        
        setAttrs(set, { silent: true });
    });
});
</script>