<div class="penombre-sheet">



    <div class="columns">
        <!-- Colonne gauche -->
        <div class="col-left">

            <!-- Identité -->
            <section class="section-identite">
                <div class="identite-container">
                    <h3 class="titre-vertical identite-titre">
                        <span>Personnage</span>
                    </h3>

                    <div class="identite-champs">
                        <div class="identite-champ"><label>Nom</label><input type="text" name="attr_char_name"></div>
                        <div class="identite-champ"><label>Peuple</label><input type="text" name="attr_peuple"></div>
                        <!-- <div><label>Clé</label><input type="text" name="attr_cle"></div>
                        <div><label>Gamme</label><input type="text" name="attr_gamme"></div>
                        <div><label>Ton</label><input type="text" name="attr_ton"></div> -->
                    </div>
                </div>
            </section>


            <!-- Harmoniques -->
            <section class="section-harmoniques">
                <div class="harmoniques-container">
                    <h3 class="titre-vertical harmoniques-titre">
                        <span>Harmoniques</span>
                    </h3>

                    <div class="harmoniques-grid">
                        <div class="harmonique-wrap">
                            <div class="harmonique">
                                <select name="attr_nuit">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Nuit</button>
                            <span class="sub-label">Action scélérate</span>

                        </div>

                        <div class="harmonique-wrap">
                            <div class="harmonique">
                                <select name="attr_ame">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Âme</button>
                            <span class="sub-label">Action sociale</span>

                        </div>

                        <div class="harmonique-wrap nature-wrap">
                            <div class="harmonique">
                                <select name="attr_nature">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Nature</button>
                            <span class="sub-label">Action physique</span>

                        </div>

                        <div class="harmonique-wrap esprit-wrap">
                            <div class="harmonique">
                                <select name="attr_esprit">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Esprit</button>
                            <span class="sub-label">Action mentale</span>
                        </div>

                        <div class="harmonique-wrap etincelle-wrap">
                            <div class="harmonique">
                                <select name="attr_etincelle">
                                    <option value="4">D4</option>
                                    <option value="6">D6</option>
                                    <option value="8">D8</option>
                                    <option value="10">D10</option>
                                    <option value="12">D12</option>
                                </select>
                            </div>
                            <button type="roll" value="" class="label-btn">Étincelle</button>
                            <span class="sub-label">Action perceptive</span>
                        </div>
                    </div>
                </div>
            </section>
            <!-- ================= Conscience ================= -->
            <section class="section-conscience">
                <div class="conscience-container">
                    <h3 class="titre-vertical conscience-titre">
                        <span>Conscience</span>
                    </h3>
                    <div class="conscience-wrapper">
                        <div class="conscience-header">
                            <h4>Max</h4>
                            <input type="number" name="attr_conscience_max" value="7" min="0" max="15">
                        </div>

                        <!-- input caché contrôlé automatiquement par le sheet-worker -->
                        <input type="hidden" name="attr_cmax" value="0">


                        <!-- Radios cachés : 1 seul attribut attr_cmax (1..10) -->
                        <div class="cmax-radios">
                            <input type="hidden" name="attr_show_token1" value="on">
                            <input type="hidden" name="attr_show_token2" value="on">
                            <input type="hidden" name="attr_show_token3" value="on">
                            <input type="hidden" name="attr_show_token4" value="on">
                            <input type="hidden" name="attr_show_token5" value="on">
                            <input type="hidden" name="attr_show_token6" value="on">
                            <input type="hidden" name="attr_show_token7" value="on">
                            <input type="hidden" name="attr_show_token8" value="0">
                            <input type="hidden" name="attr_show_token9" value="0">
                            <input type="hidden" name="attr_show_token10" value="0">
                        </div>

                        <!-- 15 jetons -->
                        <div class="tokens">
                            <div class="token"><input type="hidden" name="attr_token1" value="0"><button type="action"
                                    name="act_token1" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token2" value="0"><button type="action"
                                    name="act_token2" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token3" value="0"><button type="action"
                                    name="act_token3" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token4" value="0"><button type="action"
                                    name="act_token4" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token5" value="0"><button type="action"
                                    name="act_token5" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token6" value="0"><button type="action"
                                    name="act_token6" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token7" value="0"><button type="action"
                                    name="act_token7" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token8" value="0"><button type="action"
                                    name="act_token8" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token9" value="0"><button type="action"
                                    name="act_token9" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token10" value="0"><button type="action"
                                    name="act_token10" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token11" value="0"><button type="action"
                                    name="act_token11" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token12" value="0"><button type="action"
                                    name="act_token12" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token13" value="0"><button type="action"
                                    name="act_token13" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token14" value="0"><button type="action"
                                    name="act_token14" class="token-btn"></button></div>
                            <div class="token"><input type="hidden" name="attr_token15" value="0"><button type="action"
                                    name="act_token15" class="token-btn"></button></div>
                        </div>

                        <!-- Complications -->
                        <div class="complications">
                            <h4>Complications</h4>
                            <div class="comp-row">
                                <input type="text" name="attr_complication1">
                                <input type="checkbox" name="attr_comp1a"><input type="checkbox"
                                    name="attr_comp1b"><input type="checkbox" name="attr_comp1c">
                            </div>
                            <div class="comp-row">
                                <input type="text" name="attr_complication2">
                                <input type="checkbox" name="attr_comp2a"><input type="checkbox"
                                    name="attr_comp2b"><input type="checkbox" name="attr_comp2c">
                            </div>
                            <div class="comp-row">
                                <input type="text" name="attr_complication3">
                                <input type="checkbox" name="attr_comp3a"><input type="checkbox"
                                    name="attr_comp3b"><input type="checkbox" name="attr_comp3c">
                            </div>
                            <div class="comp-row">
                                <input type="text" name="attr_complication4">
                                <input type="checkbox" name="attr_comp4a"><input type="checkbox"
                                    name="attr_comp4b"><input type="checkbox" name="attr_comp4c">
                            </div>
                            <p class="comp-help">(pensez à en créer pour préserver vos jetons)</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Colonne droite -->
        <div class="col-right">

            <!-- Bandeau supérieur -->
            <header class="header">
                <img src="https://i.imgur.com/RqiNP2C.png" class="logo" alt="Logo Pénombre">
            </header>

            <!-- Pouvoirs -->
            <section class="section-pouvoirs">
                <h3>Pouvoirs</h3>
                <fieldset class="repeating_pouvoirs">
                    <div class="pouvoir">
                        <img src="https://i.imgur.com/FsnUzgN.png" class="icon-potentiel">
                        <input type="number" name="attr_potentiel_pouvoir" value="0" class="potentiel">
                        <input type="checkbox" class="toggle-description" title="Afficher la description">
                        <div class="input-wrapper">
                            <input type="text" name="attr_nom_pouvoir" placeholder="Nom du pouvoir" class="nom-pouvoir">
                            <textarea name="attr_desc_pouvoir" class="desc-pouvoir"
                                placeholder="Description du pouvoir..."></textarea>
                        </div>
                        <input type="text" name="attr_type_pouvoir" placeholder="Type" class="type-pouvoir">
                    </div>
                </fieldset>
            </section>

            <!-- Atouts -->
            <section class="section-atouts">
                <h3>Atouts</h3>
                <fieldset class="repeating_atouts">
                    <input type="text" name="attr_nom_atout" placeholder="Nom">
                    <input type="text" name="attr_valeur_atout" placeholder="Valeur">
                    <input type="checkbox" class="case" name="attr_case_atout">
                </fieldset>
            </section>

            <!-- Maîtrises magiques -->
            <section class="section-magie">
                <h3>Maîtrises magiques</h3>
                <fieldset class="repeating_magie">
                    <input type="text" name="attr_nom_magie" placeholder="Nom">
                    <input type="text" name="attr_harmonique_magie" placeholder="Harmonique">
                    <input type="text" name="attr_prerequis_magie" placeholder="Prérequis">
                </fieldset>
            </section>

        </div>
    </div>
</div>
<script type="text/worker">
  /* Synchronise la valeur de Conscience Max -> cmax */
  on("change:conscience_max sheet:opened", function() {
    getAttrs(["conscience_max"], function(v) {
      let cmax = parseInt(v.conscience_max, 10) || 0;
      cmax = Math.max(0, Math.min(15, cmax));
      setAttrs({ cmax: String(cmax) }, { silent: true });
    });
  });

  /* Cycle des 15 jetons (0→1→2→0) */
  const ids = Array.from({ length: 15 }, (_, i) => String(i + 1));
  ids.forEach(i => {
    on(`clicked:token${i}`, function() {
      getAttrs([`token${i}`], function(v) {
        let cur = parseInt(v[`token${i}`], 10);
        if (isNaN(cur)) cur = 0;
        const next = (cur + 1) % 3;
        const upd = {};
        upd[`token${i}`] = String(next);
        setAttrs(upd);
      });
    });
  });
</script>